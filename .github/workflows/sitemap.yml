name: Auto Index (Google ping + IndexNow)

on:
  push:
    branches: [ "main" ]
  schedule:
    - cron: "5 0 * * *"    # 07:05 WIB (00:05 UTC)
  workflow_dispatch:

permissions:
  contents: write

jobs:
  run:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      - name: Setup Node
        uses: actions/setup-node@v4
        with: { node-version: "20" }

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.x"

      # 1) Re-generate sitemap
      - name: Generate sitemap.xml
        run: node scripts/generate-sitemap.js

      # 2) Commit jika berubah
      - name: Commit updated sitemap
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "chore: auto-update sitemap"
          file_pattern: sitemap.xml

      # 3) (Opsional) Purge CDN untuk sitemap agar versi baru langsung served
      # - name: Purge Cloudflare cache (sitemap only)
      #   if: ${{ secrets.CF_ZONE_ID && secrets.CF_API_TOKEN }}
      #   run: |
      #     curl -s -X POST "https://api.cloudflare.com/client/v4/zones/${{ secrets.CF_ZONE_ID }}/purge_cache" \
      #       -H "Authorization: Bearer ${{ secrets.CF_API_TOKEN }}" \
      #       -H "Content-Type: application/json" \
      #       --data '{"files":["https://rekmakarya.com/sitemap.xml"]}'

      # 4) Tunggu Netlify deploy (poll sampai sitemap versi terbaru tersedia)
      - name: Wait until Netlify serves the fresh sitemap (max ~5 min)
        env:
          URL: https://rekmakarya.com/sitemap.xml
        run: |
          echo "Polling $URL ..."
          ATTEMPTS=30
          SLEEP=10
          ok=0
          for i in $(seq 1 $ATTEMPTS); do
            # Simulasi Googlebot juga (untuk deteksi challenge/403 dari Cloudflare)
            CODE=$(curl -s -o /dev/null -w "%{http_code}" -A "Mozilla/5.0 (compatible; Googlebot/2.1; +http://www.google.com/bot.html)" "$URL")
            echo "Attempt $i/$ATTEMPTS → HTTP $CODE"
            if [ "$CODE" = "200" ]; then
              ok=1; break
            fi
            sleep $SLEEP
          done
          if [ "$ok" != "1" ]; then
            echo "Sitemap belum 200 OK untuk Googlebot. Lanjut tetap, tapi disarankan cek Cloudflare WAF/Bot mode."
          fi

      # 5) Parse sitemap → urls.txt
      - name: Parse sitemap -> urls.txt
        run: |
          python - << 'PY'
          import xml.etree.ElementTree as ET
          ns = {'sm': 'http://www.sitemaps.org/schemas/sitemap/0.9'}
          root = ET.parse('sitemap.xml').getroot()
          urls = [u.find('sm:loc', ns).text.strip() for u in root.findall('sm:url', ns)]
          open('urls.txt','w').write("\n".join(urls))
          print(f"Wrote {len(urls)} urls")
          PY

      # 6) Ping Google (resmi)
      - name: Ping Google with sitemap
        run: |
          curl -fsS "https://www.google.com/ping?sitemap=https://rekmakarya.com/sitemap.xml" || echo "Google ping non-fatal"

      # 7) IndexNow bulk submit (chunk ≤10k, pakai Secrets)
      - name: Submit URLs to IndexNow (Bing)
        env:
          INDEXNOW_KEY: ${{ secrets.INDEXNOW_KEY }}
          HOST: rekmakarya.com
          KEYLOC: https://rekmakarya.com/indexnow.txt
        run: |
          if [ -z "$INDEXNOW_KEY" ]; then
            echo "INDEXNOW_KEY secret not set, skipping IndexNow."; exit 0
          fi

          # split per 10000 URL
          mkdir -p chunks
          split -l 10000 urls.txt chunks/urls_
          for f in chunks/urls_*; do
            URLS_JSON=$(jq -R -s 'split("\n") | map(select(length>0))' "$f")
            BODY=$(jq -n \
              --arg host "$HOST" \
              --arg key "$INDEXNOW_KEY" \
              --arg keyLocation "$KEYLOC" \
              --argjson urlList "$URLS_JSON" \
              '{host:$host, key:$key, keyLocation:$keyLocation, urlList:$urlList}')
            echo "Submitting $(wc -l < "$f") URLs to IndexNow..."
            curl -fsS -X POST "https://www.bing.com/indexnow" \
              -H "Content-Type: application/json; charset=utf-8" \
              -d "$BODY" || echo "IndexNow submit failed (non-fatal for this batch)"
          done
